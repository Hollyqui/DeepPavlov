{
	"dataset_reader": {
		"class_name": "multitask_reader",
		"task_defaults": {
			"class_name": "huggingface_dataset_reader",
			"path": "glue",
			"train": "train",
			"valid": "validation",
			"test": "test"
		},
		"tasks": {
			"cola": {
				"name": "cola"
			},
			"rte": {
				"name": "rte"
			},
			"stsb": {
				"name": "stsb"
			},
			"copa": {
				"path": "super_glue",
				"name": "copa"
			},
			"conll": {
				"class_name": "conll2003_reader",
				"use_task_defaults": false,
				"data_path": "{DOWNLOADS_PATH}/conll2003/",
				"dataset_name": "conll2003",
				"provide_pos": false
			},
			"squad": {
				"class_name": "squad_dataset_reader",
				"dataset": "squad",
				"url": "http://files.deeppavlov.ai/datasets/squad-v1.1.tar.gz",
				"data_path": "{DOWNLOADS_PATH}/squad_ru_clean/"
			}
		}
	},
	"dataset_iterator": {
		"class_name": "multitask_iterator",
		"num_train_epochs": "{NUM_TRAIN_EPOCHS}",
		"gradient_accumulation_steps": "{GRADIENT_ACC_STEPS}",
		"seed": 42,
		"task_defaults": {
			"class_name": "huggingface_dataset_iterator",
			"label": "label",
			"use_label_name": false,
			"seed": 42
		},
		"tasks": {
			"cola": {
				"features": ["sentence"]
			},
			"rte": {
				"features": ["sentence1", "sentence2"]
			},
			"stsb": {
				"features": ["sentence1", "sentence2"]
			},
			"copa": {
				"features": ["contexts", "choices"]
			},
			"conll": {
				"class_name": "basic_classification_iterator",
				"seed": 42,
				"use_task_defaults": false
			},
			"squad": {
				"class_name": "squad_iterator",
				"seed": 1337,
				"shuffle": true
			}
		}
	},
	"chainer": {
		"in": ["x_cola", "x_rte", "x_stsb", "x_copa", "x_conll", "x_squad"],
		"in_y": ["y_cola", "y_rte", "y_stsb", "y_copa", "y_conll", "y_squad"],
		"pipe": [{
				"class_name": "multitask_input_splitter",
				"in": ["x_squad"],
				"out": ["question_raw_squad", "context_raw_squad"]
			},
			{
				"class_name": "multitask_input_splitter",
				"in": ["y_squad"],
				"out": ["ans_raw_squad", "ans_raw_start_squad"]
			},
			{
				"class_name": "torch_squad_transformers_preprocessor",
				"add_token_type_ids": true,
				"vocab_file": "{BACKBONE}",
				"do_lower_case": true,
				"max_seq_length": 384,
				"in": [
					"question_raw_squad",
					"context_raw_squad"
				],
				"out": [
					"bert_features_squad",
					"subtokens_squad",
					"split_context_squad"
				]
			},
			{
				"class_name": "squad_bert_mapping",
				"do_lower_case": true,
				"in": [
					"split_context_squad",
					"bert_features_squad",
					"subtokens_squad"
				],
				"out": [
					"subtok2chars_squad",
					"char2subtoks_squad"
				]
			},
			{
				"class_name": "squad_bert_ans_preprocessor",
				"do_lower_case": true,
				"in": [
					"ans_raw_squad",
					"ans_raw_start_squad",
					"char2subtoks_squad"
				],
				"out": [
					"ans_squad",
					"ans_start_squad",
					"ans_end_squad"
				]
			},
			{
				"class_name": "multitask_pipeline_preprocessor",
				"possible_keys_to_extract": [0, 1],
				"preprocessors": [
					"TorchTransformersPreprocessor",
					"TorchTransformersPreprocessor",
					"TorchTransformersPreprocessor",
					"TorchTransformersMultiplechoicePreprocessor",
					"TorchTransformersNerPreprocessor"
				],
				"do_lower_case": true,
				"n_task": 5,
				"vocab_file": "{BACKBONE}",
				"max_seq_length": 200,
				"max_subword_length": 15,
				"token_masking_prob": 0.0,
				"return_features": true,
				"in": ["x_cola", "x_rte", "x_stsb", "x_copa", "x_conll"],
				"out": [
					"bert_features_cola",
					"bert_features_rte",
					"bert_features_stsb",
					"bert_features_copa",
					"bert_features_conll"
				]
			},
			{
				"id": "vocab_conll",
				"class_name": "simple_vocab",
				"unk_token": ["O"],
				"pad_with_zeros": true,
				"save_path": "{MODELS_PATH}/tag.dict",
				"load_path": "{MODELS_PATH}/tag.dict",
				"fit_on": ["y_conll"],
				"in": ["y_conll"],
				"out": ["y_ids_conll"]
			},
			{
				"id": "multitask_transformer",
				"class_name": "multitask_transformer",
				"optimizer_parameters": {
					"lr": 2e-5
				},
				"gradient_accumulation_steps": "{GRADIENT_ACC_STEPS}",
				"learning_rate_drop_patience": 2,
				"learning_rate_drop_div": 2.0,
				"return_probas": true,
				"backbone_model": "{BACKBONE}",
				"save_path": "{MODEL_PATH}",
				"load_path": "{MODEL_PATH}",
				"tasks": {
					"cola": {
						"type": "classification",
						"options": 2
					},
					"rte": {
						"type": "classification",
						"options": 2
					},
					"stsb": {
						"type": "regression",
						"options": 1
					},
					"copa": {
						"type": "multiple_choice",
						"options": 2
					},
					"conll": {
						"type": "sequence_labeling",
						"options": "#vocab_conll.len"
					}
				},
				"in": [
					"bert_features_cola",
					"bert_features_rte",
					"bert_features_stsb",
					"bert_features_copa",
					"bert_features_conll",
					"bert_features_squad"
				],
				"in_y": ["y_cola", "y_rte", "y_stsb", "y_copa", "y_ids_conll", "ans_squad"],
				"out": [
					"y_cola_pred_probas",
					"y_rte_pred_probas",
					"y_stsb_pred",
					"y_copa_pred_probas",
					"y_conll_pred_ids",
					"results_squad"
				]
			},
			{
				"class_name": "multitask_input_splitter",
				"in": ["results_squad"],
				"out": ["ans_start_predicted_squad",
					"ans_end_predicted_squad",
					"logits_squad",
					"scores_squad",
					"inds_squad"
				]
			},
			{
				"class_name": "squad_bert_ans_postprocessor",
				"in": [
					"ans_start_predicted_squad",
					"ans_end_predicted_squad",
					"split_context_squad",
					"subtok2chars_squad",
					"subtokens_squad",
					"inds_squad"
				],
				"out": [
					"ans_predicted_squad",
					"ans_start_predicted_squad",
					"ans_end_predicted_squad"
				]
			},
			{
				"in": ["y_cola_pred_probas"],
				"out": ["y_cola_pred_ids"],
				"class_name": "proba2labels",
				"max_proba": true
			},
			{
				"in": ["y_rte_pred_probas"],
				"out": ["y_rte_pred_ids"],
				"class_name": "proba2labels",
				"max_proba": true
			},
			{
				"in": ["y_copa_pred_probas"],
				"out": ["y_copa_pred_ids"],
				"class_name": "proba2labels",
				"max_proba": true
			},
			{
				"in": ["y_conll_pred_ids"],
				"out": ["y_conll_pred_labels"],
				"ref": "vocab_conll"
			}
		],
		"out": ["y_cola_pred_ids", "y_rte_pred_ids", "y_stsb_pred", "y_copa_pred_ids", "y_conll_pred_labels"]
	},
	"train": {
		"epochs": "{NUM_TRAIN_EPOCHS}",
		"batch_size": 32,
		"metrics": [{
				"name": "multitask_accuracy",
				"inputs": ["y_rte", "y_cola", "y_copa", "y_rte_pred_ids", "y_cola_pred_ids", "y_copa_pred_ids"]
			},
			{
				"name": "ner_f1",
				"inputs": ["y_conll", "y_conll_pred_labels"]
			},
			{
				"name": "ner_token_f1",
				"inputs": ["y_conll", "y_conll_pred_labels"]
			},
			{
				"name": "accuracy",
				"alias": "accuracy_cola",
				"inputs": ["y_cola", "y_cola_pred_ids"]
			},
			{
				"name": "accuracy",
				"alias": "accuracy_rte",
				"inputs": ["y_rte", "y_rte_pred_ids"]
			},
			{
				"name": "accuracy",
				"alias": "accuracy_copa",
				"inputs": ["y_copa", "y_copa_pred_ids"]
			},
			{
				"name": "pearson_correlation",
				"alias": "pearson_stsb",
				"inputs": ["y_stsb", "y_stsb_pred"]
			},
			{
				"name": "spearman_correlation",
				"alias": "spearman_stsb",
				"inputs": ["y_stsb", "y_stsb_pred"]
			},
			{
				"name": "squad_v1_f1",
				"inputs": [
					"ans_squad",
					"ans_predicted_squad"
				]
			},
			{
				"name": "squad_v1_em",
				"inputs": [
					"ans_squad",
					"ans_predicted_squad"
				]
			}
		],
		"validation_patience": 3,
		"val_every_n_epochs": 1,
		"log_every_n_epochs": 1,
		"show_examples": false,
		"evaluation_targets": ["valid"],
		"class_name": "torch_trainer"
	},
	"metadata": {
		"variables": {
			"ROOT_PATH": "~/.deeppavlov",
			"MODELS_PATH": "{ROOT_PATH}/models/multitask_example",
			"DOWNLOADS_PATH": "{ROOT_PATH}/downloads",
			"BACKBONE": "distilbert-base-uncased",
			"MODEL_PATH": "{MODELS_PATH}/{BACKBONE}",
			"NUM_TRAIN_EPOCHS": 5,
			"GRADIENT_ACC_STEPS": 1
		},
		"download": [{
			"url": "http://files.deeppavlov.ai/deeppavlov_data/multitask/multitask_example_v2.tar.gz",
			"subdir": "{MODELS_PATH}"
		}]
	}
}
