{
   "dataset_reader":{
    "class_name":"multitask_reader",
    "path":"super_glue",
    "reader_class_name":"huggingface_dataset_reader",
    "train":"train",
    "validation":"validation",
    "task_names":[
       "record"
    ] },  
    "dataset_iterator":{
        "class_name":"multitask_iterator",
        "num_train_epochs":"{NUM_TRAIN_EPOCHS}",
        "gradient_accumulation_steps":"{GRADIENT_ACC_STEPS}",
        "iterator_class_name":"huggingface_dataset_iterator",
        "label":"label",
        "sampling_mode":"plain",
        "use_label_name":false,
        "seed":42,
        "tasks":{
           "record":{"features":["idx","query","passage","entities","num_examples"]}
        }
     },
    "chainer": {
        "in": ["x_record"],
        "in_y": ["y_record"],
        "pipe": [
            {
                "class_name": "multitask_input_splitter",
                "keys_to_extract": [0,1,2,3,4],
                "in": ["x_record"],
                "out": ["idx_record","query_record","passage_record","entities_record","num_examples_record"]
            },
            {
                "class_name": "torch_transformers_preprocessor",
                "vocab_file": "{BACKBONE_MODEL}",
                "do_lower_case": false,
                "max_seq_length": "{SEQ_LEN}",
                "in": [
                  "query_record",
                  "passage_record"
                ],
                "out": [
                  "bert_features_record"
                ]
            },

            {
                "id": "multitask_bert",
                "class_name": "multitask_bert",
                "backbone_model":"{BACKBONE_MODEL}",
                "optimizer_parameters": {
                    "lr": 2e-5
                },
                "gradient_accumulation_steps": "{GRADIENT_ACC_STEPS}",
                "learning_rate_drop_patience": 2,
                "learning_rate_drop_div": 2.0,
                "return_probas": true,
                "max_seq_len":"{SEQ_LEN}",
                "save_path": "{MODELS_PATH}/en__bertsuperglue1record",
                "load_path": "{MODELS_PATH}/en__bertsuperglue1record",
                "tasks": {
                    "record":{"type":"classification","options": 2}
                },
                "in": [
                    "bert_features_record"
                ],
                "in_y": [
                    "y_record"
                ],
                "out": [
                    "y_record_pred_probas"
                ]
            },
            {
                "in": [
                    "y_record_pred_probas"
                ],
                "out": [
                    "y_record_pred"
                ],
                "class_name": "proba2labels",
                "max_proba": true
            },
            {
                "class_name": "torch_record_postprocessor",
                "in": [
                  "idx_record",
                  "y_record",
                  "y_record_pred_probas",
                  "entities_record",
                  "num_examples_record"
                ],
                "out": [
                  "record_examples"
                ]
              }
        ],
        "out": [
            "y_record_pred",
            "record_examples"
        ]
    },
    "train": {
        "epochs": "{NUM_TRAIN_EPOCHS}",
        "batch_size": "{BATCH_SIZE}",
        "metrics": [
              {
                "name": "accuracy",
                "alias": "accuracy_record",
                "inputs": [
                  "y_record",
                  "y_record_pred"
                ]
              },
              {
                "name": "record_em_score",
                "inputs": [
                  "record_examples"
                ]
              },
              {
                "name": "record_f1_score",
                "inputs": [
                  "record_examples"
                ]
              }
        ],
        "validation_patience": 7,
        "val_every_n_epochs": 1,
        "max_test_batches":1000,
        "log_every_n_epochs": 1,
        "show_examples": true,
        "evaluation_targets": [
            "valid", "train"
        ],
        "class_name": "torch_trainer"
    },
    "metadata": {
        "variables": {
            "ROOT_PATH": "~/.deeppavlov",
            "MODELS_PATH": "{ROOT_PATH}/.deeppavlov/models_en",
            "NUM_TRAIN_EPOCHS": 5,
            "SEQ_LEN": 320,
            "GRADIENT_ACC_STEPS": 1,
            "BATCH_SIZE": 8,
            "BACKBONE_MODEL":"bert-base-uncased",
            "SEED": 42
        }
    }
}
