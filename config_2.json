{
    "dataset_reader": {
        "class_name": "multitask_reader",
        "data_path": "glue", 
        "reader_class_name":"huggingface_dataset_reader", 
        "train" :"train", 
        "validation" :"validation", 
        "names" :["mrpc", "rte"]           
        }, 

    "dataset_iterator": {
        "class_name": "multitask_iterator",
        "num_train_epochs": "{NUM_TRAIN_EPOCHS}",
        "gradient_accumulation_steps": "{GRADIENT_ACC_STEPS}",
        "iterator_class_name": "huggingface_dataset_iterator",
        "label": "label",
        "use_label_name": false,
         "seed": 42, 
        "tasks": {
            "mrpc": {
                "features": [
                    "sentence1",
                    "sentence2"
                ],

            },
            "rte": {
                "features": [
                    "sentence1",
                    "sentence2"
                ],} 
            
        }
    },
    "chainer": {
        "in": [
            "x_mrpc_with_id",
            "x_rte_with_id"
        ],
        "in_y": [
            "y_mrpc",
            "y_rte"
        ],
        "pipe": [
            {
                "class_name": "multitask_pal_bert_pipeline_preprocessor",
                "possible_keys_to_extract":[0,1],
                "preprocessor":"TorchTransformersPreprocessor",
                "vocab_file":"{BACKBONE}", 
                "max_seq_length":128,
                "do_lower_case":true, 
                "in": [
                    "x_mrpc_with_id",
                    "x_rte_with_id"
                ],
                "out": [
                    "task_id",
                    "bert_features_mrpc",
                    "bert_features_rte"
                ]
            },
            
            {
                "id": "multitask_bert",
                "class_name": "multitask_bert",
#all config params to default. ditch in_distribution and in_y_distribution
                "optimizer_parameters": {
                    "lr": 2e-5
                },
                "gradient_accumulation_steps": "{GRADIENT_ACC_STEPS}",
                "learning_rate_drop_patience": 2,
                "learning_rate_drop_div": 2.0,
                "attention_type": "{ATTENTION_TYPE}",
                "log_model_summary": false,
                "return_probas": true,
                "backbone_model":"{BACKBONE}",
                "save_path": "{SAVE_LOAD_PATH}",
                "load_path": "{SAVE_LOAD_PATH}",
                "tasks": {
                    "mrpc": {
                        "n_classes": 2
                    },
                    "rte": {
                        "n_classes": 2
                    }
                },
                "in": [
                    "task_id",
                    "bert_features_mrpc",
                    "bert_features_rte"
                ],
                "in_y": [
                    "y_mrpc",
                    "y_rte"
                ],
                "out": [
                    "y_mrpc_pred_probas",
                    "y_rte_pred_probas"
                ]
            },
            {
                "in": [
                    "y_mrpc_pred_probas"
                ],
                "out": [
                    "y_mrpc_pred_ids"
                ],
                "class_name": "proba2labels",
                "max_proba": true
            },
            {
                "in": [
                    "y_rte_pred_probas"
                ],
                "out": [
                    "y_rte_pred_ids"
                ],
                "class_name": "proba2labels",
                "max_proba": true
            }
        ],
        "out": [
            "y_mrpc_pred_ids",
            "y_rte_pred_ids"
        ]
    },
    "train": {
        "epochs": "{NUM_TRAIN_EPOCHS}",
        "batch_size": 32,
        "metrics": [
            {
                "name": "multitask_accuracy",
                "inputs": [
                    "y_rte",
                    "y_mrpc",
                    "y_rte_pred_ids",
                    "y_mrpc_pred_ids"
                ]
            },
            {
                "name": "accuracy",
                "alias":"accuracy_mrpc",
                "inputs": [
                    "y_mrpc",
                    "y_mrpc_pred_ids"
                ]
            },
            {
                "name": "accuracy",
                "alias":"accuracy_rte",
                "inputs": [
                    "y_rte",
                    "y_rte_pred_ids"
                ]
            }                     
        ],
        "validation_patience": 3,
        "val_every_n_epochs": 1,
        "log_every_n_epochs": 1,
        "show_examples": false,
        "evaluation_targets": [
            "valid"
        ],
        "class_name": "torch_trainer"
    },
    "metadata": {
        "variables": {
            "ROOT_PATH": "/cephfs/home/karpov.d",
            "BACKBONE":"bert-base-uncased",
            "MODELS_PATH": "{ROOT_PATH}/.deeppavlov/models_glue_clean",
            "SAVE_LOAD_PATH":"{MODELS_PATH}/model2_clean",
            "NUM_TRAIN_EPOCHS":5,
            "GRADIENT_ACC_STEPS": 1
        }
    }
}
